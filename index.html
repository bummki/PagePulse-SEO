<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PagePulse SEO — On-Page Inspector (Single HTML)</title>
  <meta name="description" content="제목·메타·URL·부제목·이미지 ALT·링크·밀도·TOC·스키마·OG/Twitter·E-E-A-T까지 한 번에 점검하는 오프라인 단일 HTML SEO 체커.">
  <style>
    /* ===== iOS Dark Mode Style ===== */
    :root {
      --bg: #000000;
      --card-bg: #1c1c1e;
      --input-bg: #2c2c2e;
      --border: #38383a;
      --text: rgba(255, 255, 255, 0.95);
      --muted: #8e8e93;
      --accent: #0a84ff;
      --ok: #30d158;
      --warn: #ff9f0a;
      --fail: #ff453a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background-color: var(--bg);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    header{
      position:sticky;
      top:0;
      z-index:5;
      background:rgba(28, 28, 30, 0.75);
      backdrop-filter:blur(12px) saturate(180%);
      border-bottom: 1px solid var(--border);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    h1{font-weight:700;letter-spacing:-.2px;margin:0;font-size:1.5rem}
    .sub{color:var(--muted);font-size:.9rem}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:20px}
    .card{
      background-color: var(--card-bg);
      border-radius:16px;
      padding:20px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .card h2{margin:0 0 16px;font-size:1.1rem; font-weight: 600;}
    label{
      display:block;
      font-size: .75rem;
      color: var(--muted);
      margin: 16px 0 6px;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: .5px;
    }
    input,textarea,select{
      width:100%;
      padding:12px 14px;
      border-radius:8px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      outline:none;
      font-size: 1rem;
      font-family: inherit;
    }
    textarea{min-height:200px;resize:vertical}
    .row{display:flex;gap:12px;flex-wrap:wrap; align-items: center;}
    .btn{
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content: center;
      gap:8px;
      padding:10px 16px;
      border-radius:8px;
      border: none;
      background: var(--input-bg);
      color: var(--text);
      font-size: .9rem;
      font-weight: 600;
      transition: background-color .2s ease;
    }
    .btn:hover{background: #3a3a3c;}
    .btn:active{transform: scale(0.98);}
    .btn.primary{
      background: var(--accent);
      color: #fff;
    }
    .btn.primary:hover{ background: #007aff; }
    .tag{
      padding: 5px 10px;
      border-radius: 999px;
      background-color: var(--input-bg);
      font-size: .8rem;
      color: var(--muted);
    }
    .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .kpi > div{padding:12px;border-radius:12px;background:var(--input-bg)}
    .kpi .value{font-size:1.4rem;font-weight:700}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.fail{background:var(--fail)}
    .score{font-size:2.8rem;font-weight:800}
    .progress{height:8px;border-radius:999px;background:var(--input-bg);overflow:hidden}
    .bar{height:100%;background:var(--accent)}
    .checklist{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .item{display:flex;gap:12px;align-items:flex-start;padding:12px;border-radius:12px;background:var(--input-bg)}
    .item .msg{font-size:.9rem}
    .item .hint{color:var(--muted);font-size:.8rem;margin-top:4px}
    .footer{color:var(--muted);font-size:.8rem;margin-top:16px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .lang{margin-left:auto}
    .small{font-size:.8rem;color:var(--muted)}

    /* ===== iOS Toggle Switch ===== */
    .toggle-switch-container { display: flex; align-items: center; gap: 10px; margin: 8px 0 4px; padding: 6px 0;}
    .ios-toggle { position: absolute; opacity: 0; width: 0; height: 0; }
    .toggle-label {
        position: relative;
        display: inline-block;
        width: 51px;
        height: 31px;
        background-color: #39393d;
        border-radius: 34px;
        transition: background-color .3s;
        cursor: pointer;
    }
    .toggle-label::after {
        content: '';
        position: absolute;
        width: 27px;
        height: 27px;
        border-radius: 50%;
        background-color: white;
        top: 2px;
        left: 2px;
        transition: transform .3s;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .ios-toggle:checked + .toggle-label { background-color: var(--accent); }
    .ios-toggle:checked + .toggle-label::after { transform: translateX(20px); }

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .checklist{grid-template-columns:1fr}
      .kpi{grid-template-columns:repeat(2,1fr)}
      textarea{min-height:180px}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap row" style="align-items:center;">
    <h1>PagePulse SEO <span class="sub">— On-Page Inspector</span></h1>
    <div class="lang row" style="align-items:flex-end; gap:8px">
      <label for="uiLang" data-i="language_label" style="margin:0; text-transform:none; font-size:.8rem;">UI Language</label>
      <select id="uiLang">
        <option value="ko">한국어</option>
        <option value="en">English</option>
        <option value="ja">日本語</option>
        <option value="zh">中文</option>
        <option value="es">Español</option>
      </select>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card" style="grid-column: span 7;">
      <h2 data-i="content_input">Content Input</h2>
      <div>
        <label data-i="focus_keyword">Focus Keyword</label>
        <input id="focus" placeholder="" />
      </div>
      <div class="grid-2">
        <div>
          <label data-i="site_domain">Site Domain</label>
          <input id="domain" placeholder="" />
        </div>
        <div>
          <label data-i="prev_keywords">Previously Used Keywords</label>
          <input id="usedKeywords" placeholder="" />
        </div>
      </div>
      <label data-i="seo_title">SEO Title</label>
              <input id="title" placeholder="" />
      <div class="row" style="margin-top:8px">
        <button class="btn" id="suggestTitle">🔮 <span data-i="suggest_title">제목 개선</span></button>
        <span class="tag" id="titleLen">0 chars</span>
      </div>
      <label data-i="meta_desc">Meta Description</label>
              <textarea id="desc" placeholder=""></textarea>
      <div class="row" style="margin-top:8px">
        <span class="tag" id="descLen">0 chars</span>
      </div>
      <label data-i="url_slug">URL Slug</label>
              <input id="slug" placeholder="" />
      
      <div class="toggle-switch-container">
        <input type="checkbox" id="pillar" class="ios-toggle" />
        <label for="pillar" class="toggle-label"></label>
        <span data-i="pillar">이 게시물은 Pillar Content입니다</span>
      </div>
      
      <label data-i="main_content">Main Content (HTML or Markdown)</label>
              <textarea id="content" placeholder=""></textarea>
      <div class="row" style="margin-top:16px; justify-content:space-between;">
        <div class="row">
            <button class="btn primary" id="analyze">✅ <span data-i="run_check">실시간 분석</span></button>
            <button class="btn" id="copyReport">📋 <span data-i="copy_report">리포트 복사</span></button>
            <button class="btn" id="downloadMd">⬇️ <span data-i="download_md">Markdown 저장</span></button>
        </div>
        <div class="row">
            <button class="btn" id="makeSlug">🔧 <span data-i="make_slug">슬러그 생성</span></button>
            <button class="btn" id="addToc">🧭 <span data-i="insert_toc">[toc] 삽입</span></button>
        </div>
      </div>
    </section>

    <section class="card" style="grid-column: span 5;">
      <h2 data-i="score">Score</h2>
      <div class="row" style="align-items:center; gap:16px">
        <div class="score" id="score">0</div>
        <div style="flex:1">
          <div class="progress"><div class="bar" id="bar" style="width:0%"></div></div>
          <div class="small" id="gradeNote" style="margin-top:8px">—</div>
        </div>
      </div>
      <div class="kpi" style="margin-top:20px">
        <div>
          <div class="small" data-i="kpi_words">단어 수</div>
          <div class="value" id="kpiWords">0</div>
        </div>
        <div>
          <div class="small" data-i="kpi_density">키워드 밀도</div>
          <div class="value" id="kpiDensity">0%</div>
        </div>
        <div>
          <div class="small" data-i="kpi_images">이미지</div>
          <div class="value" id="kpiImages">0</div>
        </div>
        <div>
          <div class="small" data-i="kpi_links">링크</div>
          <div class="value" id="kpiLinks">0 / 0</div>
        </div>
      </div>
    </section>

    <section class="card" style="grid-column: span 12;">
      <h2 data-i="checklist">Checklist</h2>
      <div class="checklist" id="checklist"></div>
    </section>
  </div>
</main>

<script>
// ====== i18n (간단 사전) ======
const I18N = {
  ko:{content_input:"콘텐츠 입력", focus_keyword:"포커스 키워드", site_domain:"사이트 도메인", seo_title:"SEO 제목", suggest_title:"제목 개선", meta_desc:"메타 설명", url_slug:"URL 슬러그", prev_keywords:"이전에 사용한 키워드", pillar:"이 게시물은 Pillar Content입니다", make_slug:"슬러그 생성", insert_toc:"[toc] 삽입", main_content:"본문 (HTML/Markdown)", run_check:"실시간 분석", copy_report:"리포트 복사", download_md:"Markdown 저장", kpi_words:"단어 수", kpi_density:"키워드 밀도", kpi_images:"이미지", kpi_links:"링크",
      score:"점수", checklist:"체크리스트", step_by_step:"단계별 가이드", details:"세부 지표", language_label:"UI 언어", schema_panel:"리치 결과 & 스키마", og_panel:"OG/Twitter 메타 생성기", eeat_panel:"E‑E‑A‑T 체크리스트", copy_meta:"메타 태그 복사"},
  en:{content_input:"Content Input", focus_keyword:"Focus Keyword", site_domain:"Site Domain", seo_title:"SEO Title", suggest_title:"Improve Title", meta_desc:"Meta Description", url_slug:"URL Slug", prev_keywords:"Previously Used Keywords", pillar:"This post is Pillar Content", make_slug:"Make Slug", insert_toc:"Insert [toc]", main_content:"Main Content (HTML/Markdown)", run_check:"Live Analyze", copy_report:"Copy Report", download_md:"Save Markdown", kpi_words:"Word Count", kpi_density:"Keyword Density", kpi_images:"Images", kpi_links:"Links",
      score:"Score", checklist:"Checklist", step_by_step:"Step-by-Step (Guide)", details:"Details", language_label:"UI Language", schema_panel:"Rich Results & Schema", og_panel:"OG/Twitter Meta Generator", eeat_panel:"E‑E‑A‑T Checklist", copy_meta:"Copy meta tags"},
  ja:{content_input:"コンテンツ入力", focus_keyword:"フォーカスキーワード", site_domain:"サイトドメイン", seo_title:"SEOタイトル", suggest_title:"タイトル改善", meta_desc:"メタディスクリプション", url_slug:"URLスラッグ", prev_keywords:"過去に使用したキーワード", pillar:"この投稿はピラーコンテンツ", make_slug:"スラッグ生成", insert_toc:"[toc] 挿入", main_content:"本文 (Markdown / HTML)", run_check:"ライブ分析", copy_report:"レポートをコピー", download_md:"Markdown 保存", kpi_words:"単語数", kpi_density:"キーワード密度", kpi_images:"画像", kpi_links:"リンク",
      score:"スコア", checklist:"チェックリスト", language_label:"UI 言語"},
  zh:{content_input:"内容输入", focus_keyword:"焦点关键词", site_domain:"站点域名", seo_title:"SEO 标题", suggest_title:"优化标题", meta_desc:"元描述", url_slug:"URL 别名", prev_keywords:"以往用过的关键词", pillar:"此文为支柱内容", make_slug:"生成别名", insert_toc:"插入 [toc]", main_content:"正文 (Markdown/HTML)", run_check:"实时分析", copy_report:"复制报告", download_md:"保存 Markdown", kpi_words:"字数", kpi_density:"关键词密度", kpi_images:"图片", kpi_links:"链接",
      score:"分数", checklist:"检查清单", language_label:"界面语言"},
  es:{content_input:"Entrada de contenido", focus_keyword:"Palabra clave principal", site_domain:"Dominio del sitio", seo_title:"Título SEO", suggest_title:"Mejorar título", meta_desc:"Meta descripción", url_slug:"Slug de URL", prev_keywords:"Palabras clave usadas antes", pillar:"Este artículo es Pilar", make_slug:"Crear Slug", insert_toc:"Insertar [toc]", main_content:"Cuerpo (Markdown/HTML)", run_check:"Análisis en vivo", copy_report:"Copiar informe", download_md:"Guardar Markdown", kpi_words:"Nº de palabras", kpi_density:"Densidad", kpi_images:"Imágenes", kpi_links:"Enlaces",
      score:"Puntuación", checklist:"Lista de verificación", language_label:"Idioma"}
};
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
function setLang(lang){
  const dict = I18N[lang]||I18N.ko;
  window.PP_LANG = lang;
  $$('[data-i]').forEach(el=>{
    const k=el.getAttribute('data-i');
    if(dict[k]) el.textContent=dict[k]
  });

}
$('#uiLang').addEventListener('change',e=>setLang(e.target.value));
setLang('ko');

// ====== Helpers ======
function showToast(message,type='ok'){
  const el=document.createElement('div');
  el.className='toast '+type;
  el.setAttribute('role','status');
  el.setAttribute('aria-live','polite');
  el.textContent=message;
  document.body.appendChild(el);
  setTimeout(()=>{el.classList.add('show')},10);
  setTimeout(()=>{el.classList.remove('show'); el.addEventListener('transitionend',()=>el.remove(),{once:true})},2500);
}
const stripHtml = (html)=>html.replace(/<script[\s\S]*?<\/script>/gi,'').replace(/<style[\s\S]*?<\/style>/gi,'').replace(/<[^>]+>/g,' ');
const getWords = (txt)=> (txt||'').trim().split(/\s+|(?<![가-힣A-Za-z0-9])(?=[가-힣A-Za-z0-9])/u).filter(Boolean);
const wordCount = (txt)=> getWords(stripHtml(txt)).length;
const occ = (text, kw)=>{ if(!kw) return 0; const t=(text||'').toLowerCase(); const k=kw.toLowerCase().trim(); return (t.match(new RegExp(k.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g'))||[]).length }
const slugify = s=> (s||'').toString().trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-가-힣]/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'');
const inFirstTenPercent = (text, kw)=>{
  const words = getWords(stripHtml(text)); if(!kw||words.length===0) return false; const idx = words.join(' ').toLowerCase().indexOf(kw.toLowerCase()); if(idx<0) return false; const tenth = Math.floor(stripHtml(text).length*0.1); return idx <= tenth;
}
function parseImages(content){
  const html = content; const imgs=[];
  for(const m of html.matchAll(/<img[^>]*alt\s*=\s*"([^"]*)"[^>]*>/gi)){ imgs.push({alt:m[1]}) }
  for(const m of html.matchAll(/!\[([^\]]*)\]\(([^\)]+)\)/g)){ imgs.push({alt:m[1]}) }
  return imgs;
}
function parseLinks(content){
  const links=[]; const d=$('#domain').value.trim();
  for(const m of content.matchAll(/<a[^>]*href\s*=\s*"([^"]+)"[^>]*?(rel\s*=\s*"([^"]*)")?[^>]*>/gi)){
    const href = m[1]; const rel = (m[3]||'').toLowerCase(); const isExternal = /^https?:\/\//i.test(href) && (!d || !href.includes(d));
    const isInternal = d? href.includes(d) || /^\//.test(href) : !/^https?:\/\//i.test(href) || /^\//.test(href);
    links.push({href, isExternal, isInternal, dofollow: isExternal && !/nofollow/.test(rel)})
  }
  for(const m of content.matchAll(/\[[^\]]*\]\(([^\)]+)\)/g)){
    const href=m[1]; const isExternal = /^https?:\/\//i.test(href) && (!d || !href.includes(d));
    const isInternal = d? href.includes(d) || /^\//.test(href) : !/^https?:\/\//i.test(href) || /^\//.test(href);
    links.push({href, isExternal, isInternal, dofollow:isExternal})
  }
  return links;
}
function parseHeadings(content){
  const hs=[];
  for(const m of content.matchAll(/<h([23])[^>]*>([\s\S]*?)<\/h\1>/gi)){ hs.push({level:+m[1], text: m[2].replace(/<[^>]+>/g,'').trim()}) }
  for(const m of content.matchAll(/^\s*#{2,3}\s+(.+)$/gmi)){ const hashes=(m[0].match(/#/g)||[]).length; hs.push({level:hashes, text:m[1].trim()}) }
  return hs;
}
function hasTOC(content){ return /\[toc\]/i.test(content) || /<nav[^>]*class\s*=\s*"[^"]*toc[^"]*"/i.test(content) }
function hasMedia(content){ return /<img|!\[|<video|<iframe/i.test(content) }

function analyze(){
  const focus=$('#focus').value.trim();
  const title=$('#title').value||'';
  const desc=$('#desc').value||'';
  const slug=$('#slug').value.trim();
  const used = ($('#usedKeywords').value||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
  const pillar = $('#pillar').checked;
  const content = $('#content').value||'';
  
  // 포커스 키워드가 없으면 모든 체크를 실패로 처리
  if(!focus) {
    const list = $('#checklist'); 
    list.innerHTML='';
    $('#score').textContent = '0';
    $('#bar').style.width = '0%';
    $('#gradeNote').textContent = '포커스 키워드를 입력하세요';
    $('#kpiWords').textContent = '0';
    $('#kpiDensity').textContent = '0%';
    $('#kpiImages').textContent = '0';
    $('#kpiLinks').textContent = '0 / 0';
    $('#titleLen').textContent = '0 chars';
    $('#descLen').textContent = '0 chars';
    
    return {
      pct: 0,
      grade: 'F',
      checks: [],
      raw: {
        wordCount: 0,
        keywordOccurrences: 0,
        keywordDensity: 0,
        titleHasKw: false,
        descHasKw: false,
        urlHasKw: false,
        keywordInFirst10pct: false
      }
    };
  }

  const text = stripHtml(content);
  const wc = wordCount(content);
  const kOcc = occ(text, focus);
  const density = wc? (kOcc / wc * 100):0;
  const imgs = parseImages(content);
  const imgKw = imgs.filter(i=> (i.alt||'').toLowerCase().includes(focus.toLowerCase())).length;
  const links = parseLinks(content);
  const intLinks = links.filter(l=>l.isInternal).length;
  const extLinks = links.filter(l=>l.isExternal).length;
  const doFollowExt = links.filter(l=>l.isExternal && l.dofollow).length;
  const hs = parseHeadings(content);
  const hKw = hs.filter(h=> h.text.toLowerCase().includes(focus.toLowerCase())).length;
  const first10 = inFirstTenPercent(content, focus);
  const urlHasKw = slug.toLowerCase().includes(focus.toLowerCase());
  const titleHasKw = title.toLowerCase().includes(focus.toLowerCase());
  const titleStartsKw = title.trim().toLowerCase().startsWith(focus.toLowerCase());
  const titleHasNum = /\d/.test(title);
  const titleLen = title.length;
  const descHasKw = desc.toLowerCase().includes(focus.toLowerCase());
  const descLen = desc.length;
  const toc = hasTOC(content);
  const media = hasMedia(content);
  const usedBefore = used.includes(focus.toLowerCase());
  const altHasKw = imgKw>0;

  let score=0; const checks=[]; const add=(ok,label,hint='')=>{checks.push({ok,label,hint})}
  if(titleHasKw){score+=10; add(true,'SEO 제목에 포커스 키워드 포함','키워드는 제목 앞쪽에 배치하면 더 좋습니다.')} else {score+=0; add(false,'SEO 제목에 포커스 키워드 없음',`수정 제안: "${focus}"를 포함한 제목으로 변경하세요. 예시: "${focus} 완벽 가이드"`);}
  if(titleStartsKw){score+=5; add(true,'SEO 제목의 앞쪽에 키워드','가능하다면 키워드로 시작하세요.')} else {score+=0; add(false,'SEO 제목의 앞쪽에 키워드 아님',`수정 제안: 제목을 "${focus}"로 시작하세요. 예시: "${focus}: ${title || '완벽 가이드'}"`);}
  if(titleHasNum){score+=3; add(true,'SEO 제목에 숫자 포함','리스트/연도/수치 등은 CTR에 유리합니다.')} else {score+=0; add(false,'SEO 제목에 숫자 없음',`수정 제안: 제목에 숫자를 추가하세요. 예시: "${title || focus} 10가지 팁" 또는 "${title || focus} 2025년 가이드"`);}
  if(descHasKw){score+=8; add(true,'메타 설명에 키워드 포함',`현재 ${descLen}자 (권장 100–160자).`)} else {score+=0; add(false,'메타 설명에 키워드 없음',`수정 제안: 메타 설명에 "${focus}"를 포함하세요. 예시: "${focus}에 대한 상세한 정보와 실용적인 팁을 제공합니다. ${desc || '이 글을 통해 전문적인 지식을 얻으세요.'}"`);}
  if(descLen>=100 && descLen<=160){score+=4; add(true,'메타 설명 길이 적정',`${descLen}자`)} else {score+=0; add(false,'메타 설명 길이 부적정',`${descLen}자 (권장 100–160자)`);}
  if(urlHasKw){score+=5; add(true,'URL에 키워드 포함','슬러그는 짧고 명확하게.')} else {score+=0; add(false,'URL에 키워드 없음',`수정 제안: URL 슬러그에 "${focus}"를 포함하세요. 예시: "${focus}-guide" 또는 "${focus}-tips"`);}
  if(slug.length>0 && slug.length<=60){score+=2; add(true,'URL 길이 적정',`${slug.length}자`)} else {score+=0; add(false,'URL 길이 확인',`${slug.length}자 (권장 ≤60자)`);}
  if(first10){score+=6; add(true,'본문 처음 10% 이내 키워드 노출','초반 배치는 검색엔진 이해에 유리.') } else {score+=0; add(false,'본문 초반 키워드 미노출','도입부 2~3문장 안에 키워드를 1회 포함.');}
  if(kOcc>0){score+=6; add(true,'본문에 키워드 존재',`${kOcc}회`)} else {score+=0; add(false,'본문에 키워드 없음','본문에 최소 1회 포함하세요.');}
  if(hKw>0){score+=6; add(true,'부제목(H2/H3)에 키워드 포함',`${hKw}개 부제목에 포함`)} else {score+=0; add(false,'부제목에 키워드 없음','H2/H3에 1–2회 자연스럽게 포함.');}
  if(altHasKw){score+=4; add(true,'이미지 ALT에 키워드 포함',`${imgKw}개 ALT에 포함`)} else {score+=0; add(false,'이미지 ALT에 키워드 없음','주요 이미지 ALT에 1회 포함.');}
  if(intLinks>0){score+=4; add(true,'내부 링크 포함',`${intLinks}개`)} else {score+=0; add(false,'내부 링크 없음','관련 글로 최소 1개 연결.');}
  if(extLinks>0){score+=4; add(true,'외부 링크 포함',`${extLinks}개`)} else {score+=0; add(false,'외부 링크 없음','신뢰할 수 있는 자료 1개 이상 연결.');}
  if(doFollowExt>0){score+=2; add(true,'DoFollow 외부 링크 포함',`${doFollowExt}개`)} else {score+=0; add(false,'DoFollow 외부 링크 없음','최소 1개는 dofollow 유지.');}
  if(wc>=600 && wc<=2500){score+=10; add(true,'본문 길이 적정',`${wc} 단어`)} else {score+=0; add(false,'본문 길이 범위 밖',`${wc} 단어 (권장 600–2500)`);}
  if(density>=0.8 && density<=1.2){score+=10; add(true,'키워드 밀도 적정',`${density.toFixed(2)}%`)} else {score+=0; add(false,'키워드 밀도 부적정',`${density.toFixed(2)}% (권장 0.8–1.2%)`);}
  if(toc){score+=4; add(true,'목차(ToC) 감지','[toc] 또는 TOC 블록 존재')} else {score+=0; add(false,'목차(ToC) 없음','긴 글이면 [toc]를 추가.');}
  if(media){score+=3; add(true,'이미지/비디오 포함','멀티미디어는 체류시간에 도움.')} else {score+=0; add(false,'이미지/비디오 없음','미디어 1개 이상 추가 권장.');}
  if(pillar){score+=2; add(true,'Pillar Content 플래그','핵심 페이지로 설정됨')} else {score+=0; add(false,'Pillar Content 아님','핵심 허브라면 체크.');}
  if(!usedBefore){score+=2; add(true,'이 포커스 키워드 최초 사용','키워드 중복 최소화')} else {score+=0; add(false,'이전에 사용한 키워드','중복 사용은 피하는 것이 좋습니다.');}

  const pct = Math.max(0, Math.min(100, score));
  let grade='C'; let note='개선 여지 있음';
  if(pct>=95){grade='A+'; note='탁월한 최적화'}
  else if(pct>=85){grade='A'; note='아주 좋음'}
  else if(pct>=75){grade='B'; note='양호'}
  else if(pct>=65){grade='C'; note='보통'}
  else if(pct>=50){grade='D'; note='개선 필요'}
  else {grade='F'; note='근본 개선 필요'}

  $('#score').textContent = Math.round(pct);
  $('#bar').style.width = pct+'%';
  $('#gradeNote').textContent = note;
  $('#kpiWords').textContent = wc.toLocaleString();
  $('#kpiDensity').textContent = density.toFixed(2)+'%';
  $('#kpiImages').textContent = imgs.length;
  $('#kpiLinks').textContent = `${intLinks} / ${extLinks}`;
  $('#titleLen').textContent = `${titleLen} chars`;
  $('#descLen').textContent = `${descLen} chars`;

  const list = $('#checklist'); list.innerHTML='';
  for(const c of checks){
    const div=document.createElement('div');
    const status = c.ok===true? 'ok' : (c.ok===false? 'fail' : 'warn');
    div.className = 'item';
    div.innerHTML = `<div class="dot ${status}"></div><div><div class="msg">${c.label}</div>${c.hint?`<div class="hint">${c.hint}</div>`:''}</div>`;
    list.appendChild(div);
  }
  
  // 필요한 데이터 반환
  return {
    pct,
    grade,
    checks,
    raw: {
      wordCount: wc,
      keywordOccurrences: kOcc,
      keywordDensity: density,
      titleHasKw,
      descHasKw,
      urlHasKw,
      keywordInFirst10pct: first10
    }
  };
}

function analyzeAndPersist(){ const r=analyze(); localStorage.setItem('pagePulseSEODraft', JSON.stringify(getState())); return r }
function getState(){ return {focus:$('#focus').value,title:$('#title').value,desc:$('#desc').value,slug:$('#slug').value,domain:$('#domain').value,used:$('#usedKeywords').value,pillar:$('#pillar').checked,content:$('#content').value} }
function setState(s){ if(!s) return; $('#focus').value=s.focus||''; $('#title').value=s.title||''; $('#desc').value=s.desc||''; $('#slug').value=s.slug||''; $('#domain').value=s.domain||''; $('#usedKeywords').value=s.used||''; $('#pillar').checked=!!s.pillar; $('#content').value=s.content||''; }

$('#analyze').addEventListener('click', analyzeAndPersist);
['focus','title','desc','slug','domain','usedKeywords','pillar','content'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    const evt = (el.tagName === 'INPUT' && el.type === 'checkbox') ? 'change' : 'input';
    el.addEventListener(evt, analyzeAndPersist);
});

$('#makeSlug').addEventListener('click', ()=>{
  const title = $('#title').value.trim();
  const focus = $('#focus').value.trim();
  
  if (!title && !focus) {
    showToast('제목이나 포커스 키워드를 먼저 입력하세요.', 'warn');
    return;
  }
  
  let slugText = title || focus;
  if (title && focus && !title.toLowerCase().includes(focus.toLowerCase())) {
    // 제목에 키워드가 포함되지 않은 경우 키워드를 앞에 추가
    slugText = `${focus}-${title}`;
  }
  
  $('#slug').value = slugify(slugText);
  analyzeAndPersist();
});
$('#addToc').addEventListener('click', ()=>{ const c=$('#content'); if(!/\[toc\]/i.test(c.value)){ c.value = '[toc]\n\n' + c.value; } analyzeAndPersist() });
$('#suggestTitle').addEventListener('click', ()=>{
  const k=$('#focus').value.trim(); if(!k){ showToast('포커스 키워드를 먼저 입력하세요.','warn'); return; }
  const base = $('#title').value.trim() || k;
  const year = new Date().getFullYear();
  const ideas = [
    `${k}: ${year} 완벽 가이드`,
    `${k} — ${year} 최신 업데이트 7가지`,
    `${k} 총정리: 10가지 체크리스트`,
    `${k} 초보자용 단계별 가이드`
  ];
  let best = ideas[0];
  for(const i of ideas){ if(i.length<=60){ best=i; break } }
  $('#title').value = best; analyzeAndPersist();
});

$('#copyReport').addEventListener('click', ()=>{
  const result = analyze();
  const lines = [ `Score: ${Math.round(result.pct)} (${result.grade})`, `단어 수: ${result.raw.wordCount}`, `키워드 출현: ${result.raw.keywordOccurrences}회, 밀도: ${(result.raw.keywordOccurrences/result.raw.wordCount*100||0).toFixed(2)}%`, `제목/설명/URL 키워드: ${result.raw.titleHasKw?'O':'X'} / ${result.raw.descHasKw?'O':'X'} / ${result.raw.urlHasKw?'O':'X'}`, `초반 10% 노출: ${result.raw.keywordInFirst10pct?'O':'X'}`];
  const text = lines.join('\n');
  navigator.clipboard.writeText(text).then(()=>showToast('리포트를 복사했어요 ✅','ok')).catch(()=>showToast('복사 실패','warn'));
});

$('#downloadMd').addEventListener('click', ()=>{
  const result = analyze();
  const md = `# PagePulse SEO Report\n\n- Score: **${Math.round(result.pct)} (${result.grade})**\n\n## Checklist\n${result.checks.map(c=>`- ${c.ok===true?'✅':c.ok===false?'❌':'⚠️'} ${c.label}${c.hint?` — ${c.hint}`:''}`).join('\n')}\n`;
  const blob = new Blob([md], {type:'text/markdown'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pagepulse-seo-report.md'; a.click(); URL.revokeObjectURL(a.href);
});

try{ 
  const saved = JSON.parse(localStorage.getItem('pagePulseSEODraft')||'null'); 
  if(saved){ 
    setState(saved); 
  }
  analyze();
}catch(e){}
</script>
</body>
</html>
